name: Fetch Deployment Commit tag

on: 
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to get the last commit for'
        required: true
        default: 'main'

jobs:
  flag_status:
    runs-on: self-hosted
    outputs:
      auto_deploy_flag: ${{ steps.get_flag.outputs.auto_deploy_flag }}
      deploy_time_flag: ${{ steps.check_time.outputs.deploy_time_flag }}
      last_commit: ${{ steps.last_commit.outputs.sha }}
    steps:
      - name: Validate branch existence (GitHub API)
        id: validate_branch
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.event.inputs.target_branch }}
        run: |
          API_URL="https://api.github.com/repos/${REPO}/branches/${BRANCH}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $GH_TOKEN" "$API_URL")
          if [[ "$STATUS" -ne 200 ]]; then
            echo "Branch '$BRANCH' does not exist in $REPO"
            exit 1
          else
            echo "Branch '$BRANCH' exists in $REPO"
          fi
      - name: Get last commit for target branch (GitHub API)
        id: last_commit
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.event.inputs.target_branch }}
        run: |
          RESPONSE=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${REPO}/commits/${BRANCH}")
          SHA=$(echo "$RESPONSE" | jq -r '.sha')
          
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "Commit: $SHA"

      - name: Output the results
        run: |
          echo "SHA: ${{ steps.last_commit.outputs.sha }}"
          
      - name: Get the auto deploy flag
        id: get_flag
        run: |
          AUTO_DEPLOY_FLAG="${{ vars.AUTO_DEPLOY }}"
          echo "AUTO_DEPLOY_FLAG=${AUTO_DEPLOY_FLAG}" >> $GITHUB_ENV
          echo "auto_deploy_flag=${AUTO_DEPLOY_FLAG}" >> $GITHUB_OUTPUT
          
      - name: Check if the time to deploy matches the current time hour
        id: check_time
        run: |
          DEPLOY_HOUR="${{ vars.DEPLOY_HOUR }}"
          CURRENT_HOUR=$(date -u +%H)
          echo "Deploy hour : $DEPLOY_HOUR"
          echo "Current hour : $CURRENT_HOUR"
          if [ "$DEPLOY_HOUR" == "$CURRENT_HOUR" ]; then
            echo "Current hour matches to Deploy hour"
            echo "DEPLOY_TIME_FLAG=true" >> $GITHUB_ENV
            echo "deploy_time_flag=true" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: flag_status
    runs-on: ubuntu-latest
    if: needs.flag_status.outputs.auto_deploy_flag == 'true' && needs.flag_status.outputs.deploy_time_flag == 'true'
    steps:
      - name: Call Deployments API and parse the first code and buildCode
        run: |
          DEPLOYMENTS_JSON=$(curl -s -X GET -H "Authorization: Bearer 6d02d70de338be53dfe9286adb1fee" "https://portalapi.commerce.ondemand.com/v2/subscriptions/c9ef4f6487d4499aa3ea3d9bfd6f4957/deployments" -H 'Content-Type: application/json')
          echo "$DEPLOYMENTS_JSON"
          CODE=$(echo "$DEPLOYMENTS_JSON" | jq -r '.value[0].code')
          BUILD_CODE=$(echo "$DEPLOYMENTS_JSON" | jq -r '.value[0].buildCode')
          echo "build code is: $BUILD_CODE"
          echo "CODE=$CODE" >> $GITHUB_ENV
          echo "BUILD_CODE=$BUILD_CODE" >> $GITHUB_ENV

      - name: Call Builds API using buildCode
        run: | 
          echo "Build code is: ${{ env.BUILD_CODE }}"
          BUILD_JSON=$(curl -s -X GET -H "Authorization: Bearer 6d02d70de338be53dfe9286adb1fee" "https://portalapi.commerce.ondemand.com/v2/subscriptions/c9ef4f6487d4499aa3ea3d9bfd6f4957/builds/${{ env.BUILD_CODE }}" -H 'Content-Type: application/json')
          echo "$BUILD_JSON"
          BUILD_VERSION=$(echo "$BUILD_JSON" | jq -r '.buildVersion')
          BRANCH=$(echo "$BUILD_JSON" | jq -r '.branch')
          echo "BUILD_VERSION=$BUILD_VERSION" >> $GITHUB_ENV
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
        
         

      - name: Extract value between buildCode and branch in buildVersion
        run: | 
          
          EXTRACTED=$(echo "${{ env.BUILD_VERSION }}" | sed -e "s#.*${{ env.BUILD_CODE }}-\(.*\)-${{ env.BRANCH }}#\1#")
          echo "code: ${{ env.CODE }}"
          echo "buildCode: ${{ env.BUILD_CODE }}"
          echo "buildVersion: ${{ env.BUILD_VERSION }}"
          echo "branch: ${{ env.BRANCH }}"
          echo "Extracted : $EXTRACTED " 
          
